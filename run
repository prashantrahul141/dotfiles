#!/usr/bin/env sh

set -eu
# set -x
set -o pipefail

usage()
{
    echo ""
    echo "Usage: $0 <option: rebuild-switch|collect-garbage> [machine: thorfinn|kuujo] "
    echo ""
}

total_args=$#

# validate min args
if (( $total_args < 1 )); then
    echo "Expected atleast 1 argument(s), got $total_args"
    usage
    exit 1
fi

# validate exact args count
validate_exact_args()
{
    if (( $total_args != $1 )); then
        echo "Expected exactly $1 argument(s), got $total_args"
        usage
        exit 1
    fi
}

run()
{
    printf "Running: \033[32m%s\033[0m" "$1"
    printf "\n"
    script -q -c "$1" /dev/null
}


# rebuild-switch
rebuild_switch()
{
    run "sudo nixos-rebuild switch --flake ./hosts#$1"
    exit 0
}



option="$1"
case $option in
    "rebuild-switch")
        # validate machine
        validate_exact_args 2
        machine=$2
        case $machine in
            "thorfinn" | "kuujo")
                rebuild_switch "$machine"
                ;;
            *)
                echo "Invalid machine: $machine"
                usage
                exit 1
        esac
        ;;

    "collect-garbage")
        validate_exact_args 1
        run "sudo nix-collect-garbage -d"
        exit 0
        ;;

    *)
        echo "Invalid option: $option"
        usage
        exit 1
        ;;
esac
